# 1️⃣ Enable Swagger Security Globally

In your `main.ts`:

```ts
import { DocumentBuilder, SwaggerModule } from "@nestjs/swagger";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const config = new DocumentBuilder()
    .setTitle("My API")
    .setDescription("Example with Auth Types")
    .setVersion("1.0")
    .addBearerAuth(
      {
        type: "http",
        scheme: "bearer",
        bearerFormat: "JWT",
        description: "Paste your JWT here",
      },
      "jwt" // name of security scheme
    )
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup("docs", app, document);

  await app.listen(3000);
}
bootstrap();
```

---

# 2️⃣ Swagger Decorator for Auth

We extend our `@Auth()` decorator to **add Swagger metadata** automatically.

`auth/decorators/auth.decorator.ts`:

```ts
import { applyDecorators, SetMetadata } from "@nestjs/common";
import {
  ApiBearerAuth,
  ApiUnauthorizedResponse,
  ApiForbiddenResponse,
} from "@nestjs/swagger";
import { AuthType } from "../auth.types";

export const AUTH_TYPE_KEY = "auth_type";

export function Auth(type: AuthType = AuthType.User) {
  const decorators = [SetMetadata(AUTH_TYPE_KEY, type)];

  if (type === AuthType.User || type === AuthType.Admin) {
    decorators.push(
      ApiBearerAuth("jwt"),
      ApiUnauthorizedResponse({ description: "Invalid or missing JWT" })
    );
  }

  if (type === AuthType.Admin) {
    decorators.push(ApiForbiddenResponse({ description: "Admins only" }));
  }

  return applyDecorators(...decorators);
}

// Shortcuts
export const Public = () => Auth(AuthType.Public);
export const User = () => Auth(AuthType.User);
export const Admin = () => Auth(AuthType.Admin);
```

---

# 3️⃣ Example Controller with Swagger

`users.controller.ts`

```ts
import { Controller, Get } from "@nestjs/common";
import { CurrentUser } from "../auth/decorators/current-user.decorator";
import { Public, Admin } from "../auth/decorators/auth.decorator";

@Controller("users")
export class UsersController {
  // Public → no lock in Swagger
  @Get("welcome")
  @Public()
  getWelcome() {
    return { message: "Anyone can access this" };
  }

  // User → 🔒 lock shown
  @Get("me")
  getMe(@CurrentUser() user: any) {
    return { message: "Current user", user };
  }

  // Admin → 🔒 lock + "Admins only" note
  @Get("admin")
  @Admin()
  getAdminData(@CurrentUser() user: any) {
    return { message: "Hello Admin", user };
  }
}
```

---

# 4️⃣ Swagger UI Result

- `/users/welcome` → **no lock icon**.
- `/users/me` → 🔒 lock (requires BearerAuth).
- `/users/admin` → 🔒 lock + docs show:

  ```
  401 Unauthorized → Invalid or missing JWT
  403 Forbidden → Admins only
  ```

---

# 5️⃣ Optional — Global Auto Apply (Less Boilerplate)

If you don’t want to call `@Auth()` everywhere, you can:

- Keep **default** as `User` (already in guard).
- Add **global plugin** to auto-apply `ApiBearerAuth` unless `@Public()`.
  (This requires a small Swagger plugin, I can show you if you want).

---

# ✅ Best Practices

- Always define `401` + `403` responses → devs know **why** auth failed.
- Use one `jwt` security scheme name consistently.
- Keep `Public()` explicit, so you don’t accidentally expose routes.
- If roles get complex, extend `@Auth()` with `roles: string[]`.

# 1️⃣ The Problem

- By default, Swagger decorators (`@ApiBearerAuth`) must be **manually added**.
- We want to avoid that repetition.
- Solution: **Swagger plugin** → modify the generated OpenAPI document.

---

# 2️⃣ Swagger Plugin Setup

We’ll patch the `SwaggerModule.createDocument()` step to inject **security metadata automatically**.

In `main.ts`:

```ts
import { SwaggerModule, DocumentBuilder } from "@nestjs/swagger";
import { INestApplication } from "@nestjs/common";
import { AUTH_TYPE_KEY } from "./auth/decorators/auth.decorator";
import { AuthType } from "./auth/auth.types";
import { Reflector } from "@nestjs/core";

function setupSwagger(app: INestApplication) {
  const config = new DocumentBuilder()
    .setTitle("My API")
    .setDescription("Swagger with auto-auth")
    .setVersion("1.0")
    .addBearerAuth(
      { type: "http", scheme: "bearer", bearerFormat: "JWT" },
      "jwt"
    )
    .build();

  const document = SwaggerModule.createDocument(app, config);

  const reflector = app.get(Reflector);

  // Inject BearerAuth unless explicitly Public
  document.paths = Object.fromEntries(
    Object.entries(document.paths).map(([path, methods]) => {
      for (const [method, operation] of Object.entries<any>(methods)) {
        const route = app
          .getHttpAdapter()
          .getInstance()
          ._router.stack.find(
            (layer: any) =>
              layer.route?.path === path &&
              layer.route?.methods[method] === true
          );

        if (route) {
          const handler = route.route.stack[0].handle;
          const authType =
            reflector.get<AuthType>(AUTH_TYPE_KEY, handler) ?? AuthType.User; // default: user

          if (authType === AuthType.User || authType === AuthType.Admin) {
            operation.security = [{ jwt: [] }];
          }
        }
      }
      return [path, methods];
    })
  );

  SwaggerModule.setup("docs", app, document);
}

export default setupSwagger;
```

---

# 3️⃣ Updated `main.ts`

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // setup swagger with auto-auth plugin
  setupSwagger(app);

  await app.listen(3000);
}
bootstrap();
```

---

# 4️⃣ Example Controller

Now you only need decorators for **special cases**:

```ts
@Controller("users")
export class UsersController {
  @Get("welcome")
  @Public() // Public → no lock in Swagger
  getWelcome() {
    return { msg: "Anyone can access" };
  }

  @Get("me")
  getMe(@CurrentUser() user: any) {
    return { msg: "Current user", user };
  }

  @Get("admin")
  @Admin() // Admin → shows lock + 403 in docs
  getAdminData(@CurrentUser() user: any) {
    return { msg: "Hello Admin", user };
  }
}
```

---

# 5️⃣ Result in Swagger UI

- `/users/welcome` → ✅ no lock (public).
- `/users/me` → 🔒 auto-added BearerAuth (no decorator needed).
- `/users/admin` → 🔒 BearerAuth + `403 Admin only` note.

---

# ✅ Best Practices

- Keep `User` as **default** auth type, because 90% of endpoints are user-protected.
- Use `@Public()` **only when explicitly exposing** routes.
- Use `@Admin()` (or `@Auth(AuthType.Admin)`) for elevated access.
- Swagger stays aligned with **your guards**, no manual duplication.
