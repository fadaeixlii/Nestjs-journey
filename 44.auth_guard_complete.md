# 1Ô∏è‚É£ Auth Types and Roles

`auth.types.ts`

```ts
export enum AuthType {
  Public = "public",
  User = "user",
  Role = "role",
}

export interface AuthOptions {
  type?: AuthType;
  roles?: string[];
}
```

---

# 2Ô∏è‚É£ Auth Decorator

`auth.decorator.ts`

```ts
import { SetMetadata } from "@nestjs/common";
import { AuthOptions, AuthType } from "./auth.types";

export const AUTH_OPTIONS_KEY = "auth:options";

export const Auth = (options: AuthOptions = { type: AuthType.User }) =>
  SetMetadata(AUTH_OPTIONS_KEY, options);

export const Public = () => Auth({ type: AuthType.Public });
export const Admin = () => Auth({ type: AuthType.Role, roles: ["admin"] });
```

---

# 3Ô∏è‚É£ CurrentUser Decorator

`current-user.decorator.ts`

```ts
import { createParamDecorator, ExecutionContext } from "@nestjs/common";

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.user; // user injected by AuthGuard
  }
);
```

---

# 4Ô∏è‚É£ Auth Guard with Roles

`auth.guard.ts`

```ts
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  UnauthorizedException,
  ForbiddenException,
} from "@nestjs/common";
import { Reflector } from "@nestjs/core";
import { AuthOptions, AuthType } from "./auth.types";
import { AUTH_OPTIONS_KEY } from "./auth.decorator";
import * as jwt from "jsonwebtoken";

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(ctx: ExecutionContext): boolean {
    const handler = ctx.getHandler();
    const cls = ctx.getClass();

    const options = this.reflector.get<AuthOptions>(
      AUTH_OPTIONS_KEY,
      handler
    ) ??
      this.reflector.get<AuthOptions>(AUTH_OPTIONS_KEY, cls) ?? {
        type: AuthType.User,
      }; // default

    if (options.type === AuthType.Public) return true;

    const request = ctx.switchToHttp().getRequest();
    const authHeader = request.headers["authorization"];
    if (!authHeader) throw new UnauthorizedException("Missing Authorization");

    const [, token] = authHeader.split(" ");
    if (!token) throw new UnauthorizedException("Missing token");

    try {
      // Normally use a JWTService instead of raw lib
      const payload: any = jwt.verify(
        token,
        process.env.JWT_SECRET || "changeme"
      );
      request.user = payload;

      if (options.type === AuthType.Role) {
        if (!options.roles?.some((role) => payload.roles?.includes(role))) {
          throw new ForbiddenException(
            `Requires role: ${options.roles.join(", ")}`
          );
        }
      }

      return true;
    } catch (err) {
      throw new UnauthorizedException(err.message);
    }
  }
}
```

---

# 5Ô∏è‚É£ Apply Guard Globally

`main.ts`

```ts
import { NestFactory, Reflector } from "@nestjs/core";
import { AppModule } from "./app.module";
import { AuthGuard } from "./auth/auth.guard";
import setupSwagger from "./swagger";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Apply AuthGuard globally
  const reflector = app.get(Reflector);
  app.useGlobalGuards(new AuthGuard(reflector));

  // Swagger
  setupSwagger(app);

  await app.listen(3000);
}
bootstrap();
```

---

# 6Ô∏è‚É£ Swagger Integration with RBAC

`swagger.ts`

```ts
import { SwaggerModule, DocumentBuilder } from "@nestjs/swagger";
import { INestApplication } from "@nestjs/common";
import { Reflector } from "@nestjs/core";
import { AUTH_OPTIONS_KEY } from "./auth/auth.decorator";
import { AuthOptions, AuthType } from "./auth/auth.types";

export default function setupSwagger(app: INestApplication) {
  const config = new DocumentBuilder()
    .setTitle("My API")
    .setDescription("Swagger with Auto Auth + RBAC")
    .setVersion("1.0")
    .addBearerAuth(
      { type: "http", scheme: "bearer", bearerFormat: "JWT" },
      "jwt"
    )
    .build();

  const document = SwaggerModule.createDocument(app, config);
  const reflector = app.get(Reflector);

  // Patch OpenAPI paths
  document.paths = Object.fromEntries(
    Object.entries(document.paths).map(([path, methods]) => {
      for (const [method, operation] of Object.entries<any>(methods)) {
        const route = app
          .getHttpAdapter()
          .getInstance()
          ._router.stack.find(
            (layer: any) =>
              layer.route?.path === path &&
              layer.route?.methods[method] === true
          );

        if (route) {
          const handler = route.route.stack[0].handle;
          const options = reflector.get<AuthOptions>(
            AUTH_OPTIONS_KEY,
            handler
          ) ?? { type: AuthType.User };

          if (options.type === AuthType.User) {
            operation.security = [{ jwt: [] }];
          }
          if (options.type === AuthType.Role) {
            operation.security = [{ jwt: [] }];
            operation.description =
              (operation.description ?? "") +
              `\n\nüîí Requires roles: ${options.roles?.join(", ")}`;
          }
        }
      }
      return [path, methods];
    })
  );

  SwaggerModule.setup("docs", app, document);
}
```

---

# 7Ô∏è‚É£ Example Usage

`users.controller.ts`

```ts
import { Controller, Get } from "@nestjs/common";
import { Public, Admin, Auth } from "./auth/auth.decorator";
import { CurrentUser } from "./auth/current-user.decorator";

@Controller("users")
export class UsersController {
  @Get("welcome")
  @Public()
  getWelcome() {
    return { msg: "Anyone can access" };
  }

  @Get("me")
  getMe(@CurrentUser() user: any) {
    return { msg: "Current user", user };
  }

  @Get("admin")
  @Admin()
  getAdmin(@CurrentUser() user: any) {
    return { msg: "Admin only", user };
  }

  @Get("editor")
  @Auth({ type: "role", roles: ["editor", "manager"] })
  getEditor(@CurrentUser() user: any) {
    return { msg: "Editor/Manager access", user };
  }
}
```

---

# ‚úÖ Result

- **`/users/welcome`** ‚Üí no lock.
- **`/users/me`** ‚Üí üîí default user-protected.
- **`/users/admin`** ‚Üí üîí BearerAuth + note ‚ÄúRequires roles: admin‚Äù.
- **`/users/editor`** ‚Üí üîí BearerAuth + note ‚ÄúRequires roles: editor, manager‚Äù.

Swagger is **always in sync with Guards**.
Only minimal decorators are needed.
